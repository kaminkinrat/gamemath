<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Math Multiverse: Touch Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/gamemath/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MathGame">
    <link rel="apple-touch-icon" href="logo_192.png">



    <style>
        html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          overflow: hidden;
        }
        
        body {
          -webkit-user-select: none;
          -webkit-touch-callout: none;
        }

        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00ea;
            --neon-purple: #bc13fe;
            --neon-gold: #ffcc00;
            --bg-dark: #050510;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            user-select: none; -webkit-touch-callout: none;
            touch-action: none;
            font-family: 'Mitr', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            overflow: hidden;
            width: 100vw; height: 100dvh;
        }

        #game-container {
            position: relative;
            width: 100vw; height: 100dvh;
            background: radial-gradient(circle at center, #101025 0%, #050510 100%);
            overflow: hidden;
        }

        canvas { width: 100%; height: 100%; display: block; position: absolute; inset: 0; }

        /* Orientation Warning UI */
        #orientation-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        @media screen and (orientation: portrait) {
            #orientation-overlay { display: flex; }
        }

        .overlay {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.85); z-index: 2000; backdrop-filter: blur(15px);
            padding: 20px;
        }

        .hidden { display: none !important; }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--neon-blue);
            border-radius: 30px;
            padding: 25px;
            text-align: center;
            width: 95%; max-width: 850px;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
            max-height: 90dvh;
            overflow-y: auto;
        }

        .title { 
            font-size: 2.2rem; 
            background: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 15px 10px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .mode-btn:active { transform: scale(0.95); background: var(--neon-blue); color: black; }
        .mode-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: var(--neon-blue); }
        .mode-btn .emoji { font-size: 1.8rem; margin-bottom: 4px; }
        .mode-btn .m-name { font-weight: 700; font-size: 0.9rem; }

        #hud {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px 20px; display: flex; justify-content: space-between;
            align-items: center; pointer-events: none; z-index: 1000;
        }

        .hud-group { display: flex; gap: 8px; pointer-events: auto; }
        .hud-item { 
            background: rgba(0,0,0,0.7); 
            padding: 5px 15px; 
            border-radius: 20px; 
            border: 1.5px solid var(--neon-blue); 
            font-weight: 700; 
            color: white; 
            font-size: 0.8rem;
        }

        #choice-container {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            width: 98%; max-width: 650px; z-index: 1500;
        }

        .choice-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--neon-blue);
            color: white;
            padding: 15px 0;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: 700;
            backdrop-filter: blur(5px);
            text-align: center;
            box-shadow: 0 4px 0 rgba(0, 242, 255, 0.3);
            transition: transform 0.05s;
        }
        .choice-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0, 242, 255, 0.3); background: var(--neon-pink); }
    </style>
</head>
<body>

<div id="orientation-overlay">
    <div style="font-size: 4rem;">üì±üîÑ</div>
    <h2 style="margin-top: 20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</h2>
    <p style="opacity: 0.7; margin-top: 10px;">‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</p>
</div>

<div id="game-container">
    <canvas id="mathBgCanvas"></canvas>
    <canvas id="mainCanvas"></canvas>

    <div id="hud" class="hidden">
        <div class="hud-group">
            <div class="hud-item">HP: <span id="hp-val">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
            <div class="hud-item">SCORE: <span id="score-val">0</span></div>
        </div>
        <div class="hud-group">
            <button class="hud-item" style="background: var(--neon-pink); cursor:pointer;" onpointerdown="location.reload()">HOME</button>
        </div>
    </div>

    <div id="choice-container" class="hidden">
        <button class="choice-btn" onpointerdown="app.submitChoice(0)">-</button>
        <button class="choice-btn" onpointerdown="app.submitChoice(1)">-</button>
        <button class="choice-btn" onpointerdown="app.submitChoice(2)">-</button>
        <button class="choice-btn" onpointerdown="app.submitChoice(3)">-</button>
    </div>

    <!-- Menus -->
    <div id="menu-main" class="overlay">
        <div class="panel">
            <h1 class="title">MATH MULTIVERSE</h1>
            <div class="mode-grid" id="mode-grid-container"></div>
            <p style="font-size: 0.8rem; opacity: 0.6;">‡πÅ‡∏ï‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢</p>
        </div>
    </div>

    <div id="menu-result" class="overlay hidden">
        <div class="panel">
            <h1 class="title">GAME OVER</h1>
            <div id="result-stats" style="margin: 20px 0; font-size: 1.5rem; font-weight: 600;"></div>
            <button class="choice-btn" style="width: 100%;" onpointerdown="location.reload()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
    </div>
</div>

<script>
const MODES = [
    { id: 'baby', name: '‡πÄ‡∏ö‡∏ö‡∏µ‡πã', emoji: 'üçº', range: 5, ops: ['+'] },
    { id: 'v_easy', name: '‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å', emoji: 'üå∏', range: 10, ops: ['+', '-'] },
    { id: 'kid', name: '‡πÄ‡∏î‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢', emoji: 'üê∞', range: 15, ops: ['+', '-'] },
    { id: 'adv', name: '‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢', emoji: 'üó∫Ô∏è', range: 25, ops: ['+', '-'], hp: 5 },
    { id: 'multi', name: '‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏π‡∏ì', emoji: '‚öîÔ∏è', range: 12, ops: ['*'], speedMul: 0.9 },
    { id: 'flash_div', name: '‡∏´‡∏≤‡∏£‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤', emoji: '‚ö°', range: 10, ops: ['/'], speedMul: 1.5 },
    { id: 'sonic', name: '‡πÇ‡∏ã‡∏ô‡∏¥‡∏Ñ', emoji: 'üöÄ', range: 20, ops: ['+', '-'], speedMul: 2.5 },
    { id: 'memory', name: '‡∏à‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå', emoji: 'üß†', range: 15, ops: ['+', '-'], hideProb: true },
    { id: 'titan', name: '‡∏ö‡∏≠‡∏™‡πÉ‡∏´‡∏ç‡πà', emoji: 'üë∫', range: 50, ops: ['+', '-', '*'], speedMul: 1.8, hp: 3 },
    { id: 'zen', name: '‡πÄ‡∏ã‡∏ô', emoji: 'üéã', range: 30, ops: ['+'], speedMul: 0.4, invul: true }
];

class SoundManager {
    constructor() { 
        this.ctx = null;
        this.bgmStarted = false;
    }
    init() { 
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.startBGM();
        }
    }
    startBGM() {
        if (this.bgmStarted) return;
        this.bgmStarted = true;
        const createPad = (freq, vol) => {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(0, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 2);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
        };
        createPad(196.00, 0.02);
        createPad(261.63, 0.015);
    }
    playSuccess() { this.beep(880, 'sine', 0.2, 0.05); }
    playFail() { this.beep(120, 'sawtooth', 0.4, 0.15); }
    playGround() { this.beep(60, 'square', 0.3, 0.1); } // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ô‡∏ï‡∏Å‡∏û‡∏∑‡πâ‡∏ô
    beep(freq, type, duration, vol) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(g); g.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    }
}
const sfx = new SoundManager();

const app = {
    canvas: null, ctx: null, 
    bgCanvas: null, bgCtx: null,
    state: 'menu',
    score: 0, hp: 3, activeMode: null,
    problems: [], particles: [], mathSymbols: [],
    choices: [], currentTarget: null,
    lastSpawn: 0,

    init() {
        this.canvas = document.getElementById('mainCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.bgCanvas = document.getElementById('mathBgCanvas');
        this.bgCtx = this.bgCanvas.getContext('2d');
        
        this.renderMenu();
        this.resize();
        this.initMathBg();
        window.addEventListener('resize', () => this.resize());
        this.loop();
    },

    resize() {
        this.canvas.width = this.bgCanvas.width = window.innerWidth;
        this.canvas.height = this.bgCanvas.height = window.innerHeight;
    },

    initMathBg() {
        const chars = ['œÄ', 'Œ£', '‚àû', '‚àö', '‚à´', '‚àÜ', 'x', 'y', '+', '=', '√∑'];
        this.mathSymbols = [];
        for(let i=0; i<30; i++) {
            this.mathSymbols.push({
                x: Math.random() * window.innerWidth,
                y: Math.random() * window.innerHeight,
                char: chars[Math.floor(Math.random() * chars.length)],
                size: 15 + Math.random() * 30,
                speed: 0.2 + Math.random() * 0.5,
                opacity: 0.05 + Math.random() * 0.15
            });
        }
    },

    renderMenu() {
        const container = document.getElementById('mode-grid-container');
        MODES.forEach(m => {
            const btn = document.createElement('button');
            btn.className = 'mode-btn';
            btn.innerHTML = `<span class="emoji">${m.emoji}</span><span class="m-name">${m.name}</span>`;
            btn.onpointerdown = () => { sfx.init(); this.start(m); };
            container.appendChild(btn);
        });
    },

    start(mode) {
        this.activeMode = mode;
        this.state = 'play';
        this.score = 0;
        this.hp = mode.hp || 3;
        this.problems = [];
        this.particles = [];
        document.getElementById('menu-main').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('choice-container').classList.remove('hidden');
        this.spawnProblem();
        this.updateHUD();
    },

    spawnProblem() {
        const m = this.activeMode;
        let a, b, op, ans;
        op = m.ops[Math.floor(Math.random() * m.ops.length)];
        const range = m.range + Math.floor(this.score / 60);

        if (op === '+') { a = rand(1, range); b = rand(1, range); ans = a + b; }
        else if (op === '-') { a = rand(5, range + 5); b = rand(1, a); ans = a - b; }
        else if (op === '*') { a = rand(2, range > 20 ? 12 : range); b = rand(2, 9); ans = a * b; }
        else if (op === '/') { b = rand(2, 10); ans = rand(1, 10); a = ans * b; op = '√∑'; }

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ã‡πâ‡∏≠‡∏ô
        let safeX = 100 + Math.random() * (this.canvas.width - 200);
        const minGap = 150; 
        
        for(let attempt = 0; attempt < 15; attempt++) {
            let conflict = this.problems.some(p => Math.abs(p.x - safeX) < minGap && p.y < 150);
            if (!conflict) break;
            safeX = 100 + Math.random() * (this.canvas.width - 200);
        }

        const prob = {
            id: Date.now() + Math.random(),
            text: `${a} ${op} ${b}`,
            ans: ans,
            x: safeX,
            y: -80,
            speed: (1.1 + (this.score / 500)) * (m.speedMul || 1),
            hide: m.hideProb,
            hideTimer: 200 
        };

        this.problems.push(prob);
        if (this.problems.length === 1) this.updateChoices();
    },

    updateChoices() {
        if (this.problems.length === 0) return;
        this.currentTarget = this.problems[0];
        const correct = this.currentTarget.ans;
        let c = [correct];
        while (c.length < 4) {
            let fake = correct + rand(-10, 10);
            if (fake >= 0 && !c.includes(fake)) c.push(fake);
        }
        this.choices = c.sort(() => Math.random() - 0.5);
        const btns = document.querySelectorAll('.choice-btn');
        btns.forEach((btn, i) => btn.innerText = this.choices[i]);
    },

    submitChoice(idx) {
        if (this.state !== 'play' || !this.currentTarget) return;
        if (this.choices[idx] === this.currentTarget.ans) {
            this.score += 10;
            this.explode(this.currentTarget.x, this.currentTarget.y, varColor('--neon-blue'));
            this.problems.shift();
            this.updateChoices();
            sfx.playSuccess();
            if (this.problems.length === 0) this.spawnProblem();
        } else {
            this.triggerPenalty();
            sfx.playFail();
        }
        this.updateHUD();
    },

    triggerPenalty() {
        if (!this.activeMode.invul) this.hp--;
        if (navigator.vibrate) navigator.vibrate(100);
        if (this.hp <= 0) this.gameOver();
    },

    updateHUD() {
        document.getElementById('score-val').innerText = this.score;
        document.getElementById('hp-val').innerText = this.activeMode.invul ? '‚àû' : '‚ù§Ô∏è'.repeat(this.hp);
    },

    gameOver() {
        this.state = 'over';
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        document.getElementById('menu-result').classList.remove('hidden');
        document.getElementById('result-stats').innerText = `‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ: ${this.score}`;
    },

    explode(x, y, color) {
        for(let i=0; i<15; i++) {
            this.particles.push({
                x, y, vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12,
                life: 1, size: Math.random()*4+2, color: color || 'white'
            });
        }
    },

    update() {
        // Background update
        this.mathSymbols.forEach(s => {
            s.y -= s.speed;
            if (s.y < -50) {
                s.y = this.canvas.height + 50;
                s.x = Math.random() * this.canvas.width;
            }
        });

        if (this.state !== 'play') return;
        
        let now = Date.now();
        if (now - this.lastSpawn > 2200 && this.problems.length < 3) {
            this.spawnProblem();
            this.lastSpawn = now;
        }

        this.problems.forEach((p, i) => {
            p.y += p.speed;
            if (p.hideTimer > 0) p.hideTimer--;
            
            // ‡∏ï‡∏Å‡∏û‡∏∑‡πâ‡∏ô
            if (p.y > this.canvas.height - 110) {
                this.explode(p.x, p.y, varColor('--neon-pink'));
                this.problems.splice(i, 1);
                sfx.playGround();
                this.triggerPenalty();
                this.updateChoices();
                this.updateHUD();
                if (this.problems.length === 0 && this.state === 'play') this.spawnProblem();
            }
        });

        this.particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.025;
            if(p.life <= 0) this.particles.splice(i, 1);
        });
    },

    draw() {
        // Draw Background
        this.bgCtx.fillStyle = '#050510';
        this.bgCtx.fillRect(0, 0, this.bgCanvas.width, this.bgCanvas.height);
        
        this.mathSymbols.forEach(s => {
            this.bgCtx.globalAlpha = s.opacity;
            this.bgCtx.fillStyle = 'white';
            this.bgCtx.font = `${s.size}px Mitr`;
            this.bgCtx.fillText(s.char, s.x, s.y);
        });
        this.bgCtx.globalAlpha = 1;

        // Draw Game
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.problems.forEach(p => {
            const isTarget = this.currentTarget && p.id === this.currentTarget.id;
            this.ctx.shadowBlur = isTarget ? 15 : 0;
            this.ctx.shadowColor = varColor('--neon-blue');
            
            this.ctx.fillStyle = isTarget ? varColor('--neon-blue') : 'rgba(255,255,255,0.8)';
            this.ctx.font = `bold ${isTarget ? '42' : '30'}px 'Mitr'`;
            this.ctx.textAlign = 'center';
            let txt = (p.hide && p.hideTimer <= 0) ? '???' : p.text;
            this.ctx.fillText(txt, p.x, p.y);
            
            if (isTarget) {
                this.ctx.strokeStyle = varColor('--neon-pink');
                this.ctx.lineWidth = 3;
                this.ctx.setLineDash([5, 5]);
                this.ctx.beginPath();
                this.ctx.arc(p.x, p.y - 10, 55, 0, Math.PI*2);
                this.ctx.stroke();
                this.ctx.setLineDash([]);
            }
            this.ctx.shadowBlur = 0;
        });

        this.particles.forEach(p => {
            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            this.ctx.fill();
        });
        this.ctx.globalAlpha = 1;
    },

    loop() {
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
};

function rand(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
window.onload = () => app.init();
</script>
    <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>




