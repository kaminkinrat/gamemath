<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Math Multiverse: Neon Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00ea;
            --neon-purple: #bc13fe;
            --neon-gold: #ffcc00;
            --bg-dark: #02020a;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            user-select: none; -webkit-touch-callout: none;
            font-family: 'Mitr', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            overflow: hidden;
            width: 100vw; height: 100dvh;
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ö‡∏ô iPhone */
            overscroll-behavior-y: contain;
        }

        #game-container {
            position: relative;
            width: 100vw; height: 100dvh;
            background: #000;
            overflow: hidden;
        }

        canvas { width: 100%; height: 100%; display: block; position: absolute; inset: 0; }

        /* Combo Notification */
        #combo-notification {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1800;
            opacity: 0;
            transition: opacity 0.2s ease-out;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #combo-notification.active {
            opacity: 1;
            animation: screen-shake 0.1s infinite;
        }

        @keyframes screen-shake {
            0% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, -2px); }
            100% { transform: translate(1px, -1px); }
        }

        .rainbow-rect {
            position: absolute;
            inset: 0px;
            border: 10px solid transparent;
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rainbow-rotate 1.5s linear infinite;
        }

        @keyframes rainbow-rotate {
            0% { filter: hue-rotate(0deg) brightness(1.1); }
            100% { filter: hue-rotate(360deg) brightness(1.3); }
        }

        .overlay {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); z-index: 2000; backdrop-filter: blur(8px);
            padding: 20px;
        }

        .hidden { display: none !important; }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(0, 242, 255, 0.4);
            border-radius: 30px;
            padding: 25px;
            text-align: center;
            width: 95%; max-width: 900px;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.15);
            max-height: 90dvh;
            overflow-y: auto;
            z-index: 2100;
        }

        .title { 
            font-size: 2.8rem; 
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00f2ff, #ff00ea);
            background-size: 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-rainbow 8s linear infinite;
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        @keyframes text-rainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.06);
            color: white;
            padding: 15px 10px;
            border-radius: 15px;
            border: 1px solid rgba(0, 242, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 110px;
        }
        .mode-btn:hover { background: rgba(0, 242, 255, 0.15); border-color: var(--neon-blue); transform: translateY(-3px); }

        .mode-name { font-weight: 700; font-size: 0.95rem; margin-top: 5px; color: #fff; }
        .mode-desc { font-size: 0.65rem; color: var(--neon-blue); opacity: 0.9; margin-top: 4px; line-height: 1.2; }

        #hud {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 25px; display: flex; justify-content: space-between;
            align-items: center; pointer-events: none; z-index: 1000;
        }

        .hud-group { display: flex; gap: 8px; pointer-events: auto; }

        .hud-item { 
            background: rgba(0,0,0,0.7); 
            padding: 6px 15px; 
            border-radius: 20px; 
            border: 1.5px solid var(--neon-blue); 
            font-weight: 700; color: white;
            font-size: 0.85rem;
            display: flex; align-items: center;
        }

        .icon-btn {
            width: 40px; height: 40px; padding: 0; justify-content: center; cursor: pointer;
        }

        #choice-container {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            width: 95%; max-width: 650px; z-index: 1500;
        }

        .choice-btn {
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--neon-blue);
            color: white;
            padding: 12px 0;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 0 0 8px var(--neon-blue);
            box-shadow: 0 4px 0 rgba(0, 242, 255, 0.4);
            transition: all 0.1s;
        }
        .choice-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 var(--neon-blue); background: var(--neon-pink); }

        /* Settings UI */
        .settings-row {
            display: flex; align-items: center; justify-content: space-between;
            margin: 20px 0; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;
        }
        .settings-label { font-weight: 600; color: var(--neon-blue); }
        
        input[type=range] {
            -webkit-appearance: none; width: 60%; background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 4px;
            border: 1px solid var(--neon-blue);
        }
        input[type=range]::-webkit-slider-thumb {
            height: 20px; width: 20px; border-radius: 50%; background: var(--neon-pink);
            cursor: pointer; -webkit-appearance: none; margin-top: -7px; box-shadow: 0 0 10px var(--neon-pink);
        }

        #orientation-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        @media screen and (orientation: portrait) { #orientation-overlay { display: flex; } }




html, body {
    position: fixed;
    width: 100%;
    height: 100%;
}



#mobile-exit-btn {
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 99999;
    padding: 10px 18px;
    border-radius: 25px;
    border: 2px solid var(--neon-pink);
    background: rgba(0,0,0,0.8);
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 0 20px var(--neon-pink);
    display: none;
}


    </style>
</head>
<body>

<div id="orientation-overlay">
    <div style="font-size: 4rem;">üì±üîÑ</div>
    <h2 style="margin-top: 20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</h2>
    <p>‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏∏‡∏Å!</p>
</div>

<div id="game-container">
    <div id="combo-notification">
        <div class="rainbow-rect"></div>
        <div style="font-size: 4rem; font-weight: 900; color: white; text-shadow: 0 0 20px black;">COMBO!!</div>
        <button id="mobile-exit-btn">‚§´ ‡∏≠‡∏≠‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>


    </div>

    <canvas id="mathBgCanvas"></canvas>
    <canvas id="mainCanvas"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden">
        <div class="hud-group">
            <div class="hud-item">HP: <span id="hp-val">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
            <div class="hud-item">SCORE: <span id="score-val">0</span></div>
            <div class="hud-item" id="combo-hud" style="color: var(--neon-gold); display: none; border-color: var(--neon-gold);">COMBO: <span id="combo-val">0</span></div>
        </div>
        <div class="hud-group">
            <button class="hud-item icon-btn" onclick="app.toggleSettings(true)" style="border-color: var(--neon-gold);">‚öôÔ∏è</button>
            <button class="hud-item" style="background: var(--neon-pink); cursor:pointer; border-color: white;" onclick="app.goHome()">HOME</button>
        </div>
    </div>

    <!-- Gameplay Choices -->
    <div id="choice-container" class="hidden">
        <button class="choice-btn" onpointerdown="app.submitChoice(0)">-</button>
        <button class="choice-btn" onpointerdown="app.submitChoice(1)">-</button>
        <button class="choice-btn" onpointerdown="app.submitChoice(2)">-</button>
        <button class="choice-btn" onpointerdown="app.submitChoice(3)">-</button>
    </div>

    <!-- Main Menu -->
    <div id="menu-main" class="overlay">
        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div style="width: 40px;"></div>
                <h1 class="title">MATH MULTIVERSE</h1>
                <button class="hud-item icon-btn" onclick="app.toggleSettings(true)" style="background: transparent; border-color: var(--neon-gold); font-size: 1.2rem;">‚öôÔ∏è</button>
            </div>
            <div class="mode-grid" id="mode-grid-container"></div>
            <p style="color: var(--neon-blue); font-weight: 600; font-size: 0.9rem;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</p>
        </div>
    </div>

    <!-- Settings Menu -->
    <div id="menu-settings" class="overlay hidden">
        <div class="panel" style="max-width: 500px;">
            <h2 class="title" style="font-size: 2rem;">SETTINGS</h2>
            
            <div class="settings-row">
                <span class="settings-label">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ (Music)</span>
                <input type="range" id="vol-music" min="0" max="100" value="50" oninput="app.updateVolume()">
            </div>
            
            <div class="settings-row">
                <span class="settings-label">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå (SFX)</span>
                <input type="range" id="vol-sfx" min="0" max="100" value="70" oninput="app.updateVolume()">
            </div>

            <div class="settings-row">
                <span class="settings-label">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏ô (Vibration)</span>
                <button id="vibrate-toggle" class="hud-item" onclick="app.toggleVibrate()" style="width: 100px; justify-content: center;">‡πÄ‡∏õ‡∏¥‡∏î</button>
            </div>

            <button class="choice-btn" style="width: 100%; margin-top: 20px;" onclick="app.toggleSettings(false)">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- Game Over -->
    <div id="menu-result" class="overlay hidden">
        <div class="panel">
            <h1 class="title">GAME OVER</h1>
            <div id="result-stats" style="margin: 20px 0; font-size: 1.6rem; font-weight: 700; color: white;"></div>
            <button class="choice-btn" style="width: 100%;" onclick="app.goHome()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>
</div>

<script>
const MODES = [
    { id: 'baby', name: '‡πÄ‡∏ö‡∏ö‡∏µ‡πã', emoji: 'üçº', desc: '‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡∏á‡πà‡∏≤‡∏¢‡πÜ 1-5', range: 5, ops: ['+'], speedMul: 0.7 },
    { id: 'v_easy', name: '‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å', emoji: 'üå∏', desc: '‡∏ö‡∏ß‡∏Å ‡∏•‡∏ö ‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', range: 10, ops: ['+', '-'], speedMul: 0.8 },
    { id: 'kid', name: '‡πÄ‡∏î‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢', emoji: 'üê∞', desc: '‡πÄ‡∏•‡∏Ç‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô 1-15', range: 15, ops: ['+', '-'], speedMul: 1.0 },
    { id: 'hyper', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏™‡∏á', emoji: '‚ö°', desc: '‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', range: 20, ops: ['+', '-'], speedMul: 1.25, ramp: true },
    { id: 'multi', name: '‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏π‡∏ì', emoji: '‚öîÔ∏è', desc: '‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏π‡∏ì‡πÅ‡∏°‡πà 2-12', range: 12, ops: ['*'], speedMul: 0.9 },
    { id: 'div', name: '‡∏´‡∏≤‡∏£‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤', emoji: '‚ö°', desc: '‡∏ù‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡πÄ‡∏•‡∏Ç‡∏•‡∏á‡∏ï‡∏±‡∏ß', range: 10, ops: ['/'], speedMul: 1.1 },
    { id: 'sonic', name: '‡πÇ‡∏ã‡∏ô‡∏¥‡∏Ñ', emoji: 'üöÄ', desc: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£', range: 25, ops: ['+', '-'], speedMul: 4 },
    { id: 'memory', name: '‡∏à‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå', emoji: 'üß†', desc: '‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß!', range: 15, ops: ['+', '-'], hideProb: true, speedMul: 0.95, hideDelay: 180 },
    { id: 'titan', name: '‡∏ö‡∏≠‡∏™‡πÉ‡∏´‡∏ç‡πà', emoji: 'üë∫', desc: '‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢', range: 60, ops: ['+', '-', '*', '/'], speedMul: 1.6 },
    { id: 'chill', name: '‡∏ä‡∏¥‡∏•‡πÜ', emoji: 'üéã', desc: '‡∏ö‡∏ß‡∏Å‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏≠‡∏°‡∏ï‡∏∞', range: 30, ops: ['+'], speedMul: 0.5, invul: true }
];

class SoundManager {
    constructor() { 
        this.ctx = null; 
        this.bgGain = null;
        this.sfxGain = null;
        this.isPlayingMusic = false;
        this.musicVol = 0.2; 
        this.sfxVol = 0.7;
    }
    init() { 
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.bgGain = this.ctx.createGain();
            this.sfxGain = this.ctx.createGain();
            this.bgGain.connect(this.ctx.destination);
            this.sfxGain.connect(this.ctx.destination);
            this.updateVolumes(this.musicVol, this.sfxVol);
            this.startAmbience();
        }

        this.exitBtn = document.getElementById('mobile-exit-btn');

this.exitBtn.onclick = () => {
    if (document.fullscreenElement) {
        document.exitFullscreen().catch(()=>{});
    }
};


    }
    
    updateVolumes(m, s) {
        this.musicVol = m;
        this.sfxVol = s;
        if (this.bgGain) this.bgGain.gain.setTargetAtTime(this.musicVol, this.ctx.currentTime, 0.1);
        if (this.sfxGain) this.sfxGain.gain.setTargetAtTime(this.sfxVol, this.ctx.currentTime, 0.1);
    }

    startAmbience() {
        if (this.isPlayingMusic) return;
        this.isPlayingMusic = true;
        
        const playPad = (freq, delay) => {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            g.gain.setValueAtTime(0, this.ctx.currentTime);
            g.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime + 2);
            g.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 6);
            osc.connect(g);
            g.connect(this.bgGain);
            osc.start(this.ctx.currentTime + delay);
            osc.stop(this.ctx.currentTime + delay + 7);
            setTimeout(() => playPad(freq, 0), 8000 + (Math.random() * 2000));
        };
        
        playPad(110, 0); 
        playPad(164.81, 2); 
        playPad(220, 4); 
    }

    playSuccess() { this.beep(880, 'sine', 0.2, 0.3); }
    playFail() { this.beep(110, 'sawtooth', 0.4, 0.4); } 
    playCombo() { this.beep(1320, 'sine', 0.6, 0.5); }
    beep(freq, type, duration, vol) {
        if (!this.ctx) return;
        try {
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            g.gain.setValueAtTime(vol, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(g); g.connect(this.sfxGain);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        } catch(e){}
    }
}
const sfx = new SoundManager();

const app = {
    canvas: null, ctx: null, 
    bgCanvas: null, bgCtx: null,
    state: 'menu', prevState: 'menu',
    score: 0, hp: 4, combo: 0,
    lastFrameTime: 0,
    activeMode: null,
    problems: [], particles: [], stars: [],
    choices: [], currentTarget: null,
    lastSpawn: 0,
    spawnDelay: 2000, 
    speedFactor: 1.0,
    hueOffset: 0,
    vibrateEnabled: true,
    isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,

    init() {
        this.canvas = document.getElementById('mainCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.bgCanvas = document.getElementById('mathBgCanvas');
        this.bgCtx = this.bgCanvas.getContext('2d');
        this.renderMenu();
        this.resize();
        this.initSpaceBg();
        window.addEventListener('resize', () => this.resize());
        
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone: ‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô Address Bar
    const triggerFullscreen = () => {
        sfx.init();
        this.handleFullscreen();
        document.removeEventListener('pointerdown', triggerFullscreen);
    };

    document.addEventListener('pointerdown', triggerFullscreen);
        this.loop();
    },

    handleFullscreen() {
        // ‡∏Å‡∏£‡∏ì‡∏µ iPhone (Safari) - ‡πÉ‡∏ä‡πâ Scroll ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÅ‡∏ó‡∏ô Fullscreen API
        if (this.isIOS) {
            window.scrollTo(0, 0);
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô URL bar
            if (document.documentElement.scrollHeight < window.innerHeight + 100) {
                // ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ã‡πà‡∏≠‡∏ô UI ‡∏ö‡∏ô iPhone ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ scroll ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
            }
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Android, iPadOS, Desktop)
        if (!document.fullscreenElement && 
            !document.webkitFullscreenElement && 
            !document.mozFullScreenElement && 
            !document.msFullscreenElement) {
            
            const el = document.documentElement;
            const request = el.requestFullscreen || 
                          el.webkitRequestFullscreen || 
                          el.mozRequestFullScreen || 
                          el.msRequestFullscreen;
            
            if (request) {
                request.call(el).catch(() => {});
            }
        }
    },

    resize() {
        this.canvas.width = this.bgCanvas.width = window.innerWidth;
        this.canvas.height = this.bgCanvas.height = window.innerHeight;
        this.initSpaceBg();
    },

    toggleSettings(show) {
        if (show) {
            this.prevState = this.state;
            this.state = 'settings';
            document.getElementById('menu-settings').classList.remove('hidden');
        } else {
            this.state = this.prevState;
            document.getElementById('menu-settings').classList.add('hidden');
        }
    },

    updateVolume() {
        const m = document.getElementById('vol-music').value / 200; 
        const s = document.getElementById('vol-sfx').value / 100;
        sfx.updateVolumes(m, s);
    },

    toggleVibrate() {
        this.vibrateEnabled = !this.vibrateEnabled;
        document.getElementById('vibrate-toggle').innerText = this.vibrateEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
    },

    doVibrate(pattern) {
        if (this.vibrateEnabled && navigator.vibrate) {
            navigator.vibrate(pattern);
        }
    },

    initSpaceBg() {
        const chars = ['œÄ', 'Œ£', '‚àû', '‚àö', '‚à´', 'x', 'y', 'z', 'f', 'Œª', 'Œ∏', 'Œî', '1', '0', '+', '-', '='];
        this.stars = [];
        const count = this.state === 'menu' ? 60 : 25; 
        for(let i=0; i<count; i++) {
            this.stars.push({
                x: Math.random() * this.canvas.width - this.canvas.width/2,
                y: Math.random() * this.canvas.height - this.canvas.height/2,
                z: Math.random() * this.canvas.width,
                char: chars[Math.floor(Math.random() * chars.length)],
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5
            });
        }
    },

    renderMenu() {
        const container = document.getElementById('mode-grid-container');
        container.innerHTML = ''; // Clear old items
        MODES.forEach(m => {
            const btn = document.createElement('button');
            btn.className = 'mode-btn';
            btn.innerHTML = `
                <div style="font-size:1.6rem;">${m.emoji}</div>
                <div class="mode-name">${m.name}</div>
                <div class="mode-desc">${m.desc}</div>
            `;
            btn.onclick = (e) => { 
                e.stopPropagation();
                sfx.init(); 
                this.handleFullscreen();
                this.start(m); 
            };
            container.appendChild(btn);
        });
    },

    start(mode) {
        this.activeMode = mode;
        this.state = 'play';
        this.score = 0; this.hp = 4; this.combo = 0; this.speedFactor = 1.0;
        this.problems = []; this.particles = [];
        this.lastSpawn = Date.now();
        this.initSpaceBg();
        document.getElementById('menu-main').classList.add('hidden');
        document.getElementById('menu-result').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('choice-container').classList.remove('hidden');
        this.spawnProblem();
        this.updateHUD();
    },

    goHome() {
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å reload ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤ Fullscreen
        this.state = 'menu';
        this.problems = [];
        this.particles = [];
        this.score = 0;
        this.combo = 0;
        this.initSpaceBg();
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('choice-container').classList.add('hidden');
        document.getElementById('menu-result').classList.add('hidden');
        document.getElementById('menu-settings').classList.add('hidden');
        document.getElementById('menu-main').classList.remove('hidden');
        this.renderMenu();
    },

    spawnProblem() {
        const m = this.activeMode;
        if (!m) return;
        let a, b, op, ans;
        op = m.ops[Math.floor(Math.random() * m.ops.length)];
        const range = m.range + Math.floor(this.score / 100);

        if (op === '+') { a = rand(1, range); b = rand(1, range); ans = a + b; }
        else if (op === '-') { a = rand(5, range + 5); b = rand(1, a); ans = a - b; }
        else if (op === '*') { a = rand(2, 12); b = rand(2, 10); ans = a * b; }
        else if (op === '/') { b = rand(2, 10); ans = rand(1, 10); a = ans * b; op = '√∑'; }

        let newX = 150 + Math.random() * (this.canvas.width - 300);
        let attempts = 0;
        while(attempts < 10) {
            let conflict = this.problems.some(p => Math.abs(p.x - newX) < 130 && p.y < 200);
            if (!conflict) break;
            newX = 150 + Math.random() * (this.canvas.width - 300);
            attempts++;
        }

        const prob = {
            id: Date.now() + Math.random(),
            text: `${a} ${op === '*' ? '√ó' : op} ${b}`,
            ans: ans,
            x: newX,
            y: -80,
            speed: (0.7 + (this.score / 900)) * m.speedMul * this.speedFactor,
            hide: m.hideProb,
            hideTimer: m.hideDelay || 0,
            seed: Math.random() * 360 
        };

        this.problems.push(prob);
        if (this.problems.length === 1) this.updateChoices();
        this.spawnDelay = Math.max(800, 2400 / this.speedFactor);
    },

    updateChoices() {
        if (this.problems.length === 0) return;
        this.currentTarget = this.problems[0];
        const correct = this.currentTarget.ans;
        let c = [correct];
        while (c.length < 4) {
            let fake = correct + rand(-12, 12);
            if (fake >= 0 && !c.includes(fake)) c.push(fake);
        }
        this.choices = c.sort(() => Math.random() - 0.5);
        const btns = document.querySelectorAll('.choice-btn');
        btns.forEach((btn, i) => btn.innerText = this.choices[i]);
    },

    submitChoice(idx) {
        if (this.state !== 'play' || !this.currentTarget) return;
        if (this.choices[idx] === this.currentTarget.ans) {
            this.score += 10 + (this.combo * 5);
            this.combo++;
            if (this.activeMode.ramp) {
    this.speedFactor = Math.min(this.speedFactor + 0.02, 2.2);
}

            if (this.combo > 0 && this.combo % 5 === 0) this.triggerComboAlert();
            this.explode(this.currentTarget.x, this.currentTarget.y, `hsl(${this.hueOffset}, 100%, 70%)`);
            this.problems.shift();
            this.updateChoices();
            sfx.playSuccess();
            this.lastSpawn = Date.now() - 500;
        } else {
            this.combo = 0;
            this.triggerPenalty();
            sfx.playFail();
        }
        this.updateHUD();
    },

    triggerComboAlert() {
        sfx.playCombo();
        this.doVibrate([80, 40, 80]);
        const notification = document.getElementById('combo-notification');
        notification.classList.add('active');
        setTimeout(() => notification.classList.remove('active'), 1200);
    },

    triggerPenalty() {
        if (!this.activeMode.invul) this.hp--;
        this.doVibrate([200]);
        if (this.hp <= 0) this.gameOver();
    },

    updateHUD() {
        document.getElementById('score-val').innerText = this.score;
        document.getElementById('hp-val').innerText = (this.activeMode && this.activeMode.invul) ? '‚àû' : '‚ù§Ô∏è'.repeat(Math.max(0, this.hp));
        const comboHud = document.getElementById('combo-hud');
        if (this.combo >= 2) {
            comboHud.style.display = 'block';
            document.getElementById('combo-val').innerText = this.combo;
        } else {
            comboHud.style.display = 'none';
        }
    },

    gameOver() {
        this.state = 'over';
        this.doVibrate([500]);
        document.getElementById('menu-result').classList.remove('hidden');
        document.getElementById('result-stats').innerText = `üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${this.score} | üî• ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${this.combo}`;
    },

    explode(x, y, color) {
        for(let i=0; i<8; i++) {
            this.particles.push({
                x, y, vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12,
                life: 1, size: Math.random()*4+2, color: color
            });
        }
    },

    update() {
        this.hueOffset = (this.hueOffset + 1) % 360;
        // ===== ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å fullscreen =====
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

if (this.exitBtn) {
    if (isMobile && document.fullscreenElement) {
        this.exitBtn.style.display = 'block';
    } else {
        this.exitBtn.style.display = 'none';
    }
}
// =========================================

        if (this.state === 'menu' || this.state === 'settings') {
            this.stars.forEach(s => {
                s.x += s.vx; s.y += s.vy;
                if (s.x > this.canvas.width/2) s.x = -this.canvas.width/2;
                if (s.x < -this.canvas.width/2) s.x = this.canvas.width/2;
                if (s.y > this.canvas.height/2) s.y = -this.canvas.height/2;
                if (s.y < -this.canvas.height/2) s.y = this.canvas.height/2;
            });
        } else {
            const warpSpeed = 2 + (this.score/500);
            this.stars.forEach(s => {
                s.z -= warpSpeed;
                if (s.z <= 0) {
                    s.z = this.canvas.width;
                    s.x = Math.random() * this.canvas.width - this.canvas.width/2;
                    s.y = Math.random() * this.canvas.height - this.canvas.height/2;
                }
            });
        }

        if (this.state !== 'play') return;
        
        let now = Date.now();
        const maxActive = 3; // fix ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß

        if (now - this.lastSpawn > this.spawnDelay && this.problems.length < maxActive) {
            this.spawnProblem();
            this.lastSpawn = now;
        }

        this.problems.forEach((p, i) => {
            p.y += p.speed;
            if (p.hideTimer > 0) p.hideTimer--;
            if (p.y > this.canvas.height - 110) {
                this.problems.splice(i, 1);
                this.combo = 0;
                this.triggerPenalty();
                this.updateChoices();
                this.updateHUD();
                this.lastSpawn = Date.now();
            }
        });

        this.particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.035;
            if(p.life <= 0) this.particles.splice(i, 1);
        });

        // safety guard
if (this.problems.length > 6) {
    this.problems.splice(3);
}

    },

    draw() {
        this.bgCtx.fillStyle = '#010106';
        this.bgCtx.fillRect(0, 0, this.bgCanvas.width, this.bgCanvas.height);
        
        const cx = this.bgCanvas.width / 2;
        const cy = this.bgCanvas.height / 2;
        
        if (this.state === 'menu' || this.state === 'settings') {
            this.stars.forEach(s => {
                const sx = s.x + cx;
                const sy = s.y + cy;
                this.bgCtx.globalAlpha = 0.35;
                this.bgCtx.fillStyle = `hsl(${(this.hueOffset + s.z/2)%360}, 60%, 70%)`;
                this.bgCtx.font = `20px Mitr`;
                this.bgCtx.fillText(s.char, sx, sy);
            });
        } else {
            this.stars.forEach(s => {
                const sx = (s.x / s.z) * cx + cx;
                const sy = (s.y / s.z) * cy + cy;
                const size = (1 - s.z / this.bgCanvas.width) * 12;
                const alpha = (1 - s.z / this.bgCanvas.width) * 0.5;
                this.bgCtx.globalAlpha = alpha;
                this.bgCtx.fillStyle = `hsl(${(this.hueOffset + s.z)%360}, 40%, 60%)`;
                this.bgCtx.font = `bold ${size + 6}px Mitr`;
                this.bgCtx.fillText(s.char, sx, sy);
            });
        }

        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.problems.forEach(p => {
            const isTarget = this.currentTarget && p.id === this.currentTarget.id;
            this.ctx.font = `bold ${isTarget ? '38' : '28'}px 'Mitr'`;
            this.ctx.textAlign = 'center';
            let txt = (p.hide && p.hideTimer <= 0) ? '???' : p.text;
            const gradient = this.ctx.createLinearGradient(p.x - 40, p.y, p.x + 40, p.y);
            gradient.addColorStop(0, `hsl(${this.hueOffset + p.seed}, 100%, 70%)`);
            gradient.addColorStop(1, `hsl(${this.hueOffset + p.seed + 60}, 100%, 70%)`);
            this.ctx.fillStyle = gradient;
            this.ctx.shadowBlur = isTarget ? 6 : 0;
            this.ctx.shadowColor = `hsl(${this.hueOffset + p.seed}, 100%, 50%)`;
            this.ctx.fillText(txt, p.x, p.y);
            this.ctx.shadowBlur = 0;
            
            if (isTarget) {
                const time = Date.now() * 0.003;
                this.ctx.save();
                this.ctx.translate(p.x, p.y - 12);
                this.ctx.rotate(time);
                this.ctx.shadowBlur = 12;
                this.ctx.shadowColor = varColor('--neon-pink');
                this.ctx.strokeStyle = varColor('--neon-pink');
                this.ctx.lineWidth = 3;
                this.ctx.setLineDash([12, 6]);
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 55, 0, Math.PI * 2);
                this.ctx.stroke();
                this.ctx.rotate(-time * 1.5);
                this.ctx.strokeStyle = varColor('--neon-blue');
                this.ctx.lineWidth = 1.5;
                this.ctx.setLineDash([3, 3]);
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 48, 0, Math.PI * 2);
                this.ctx.stroke();
                this.ctx.restore();
            }
        });

        this.particles.forEach(p => {
            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            this.ctx.fill();
        });
        this.ctx.globalAlpha = 1;
    },

loop(timestamp) {
    if (!this.lastFrameTime) this.lastFrameTime = timestamp;
    const delta = timestamp - this.lastFrameTime;
    this.lastFrameTime = timestamp;

    if (delta < 40) { // ‡∏ñ‡πâ‡∏≤ fps ‡∏¢‡∏±‡∏á‡πÇ‡∏≠‡πÄ‡∏Ñ
        this.update();
        this.draw();
    }

    requestAnimationFrame((t) => this.loop(t));
}

};

function rand(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
window.onload = () => app.init();
</script>
</body>
</html>





















