<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Math Multiverse: High Performance Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;700&family=Orbitron:wght@400;700&display=swap');

        :root {
            --primary: #00f2fe;
            --secondary: #7000ff;
            --danger: #ff0055;
            --success: #00ff88;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #020617;
            font-family: 'Prompt', sans-serif;
            touch-action: manipulation;
            user-select: none;
        }

        canvas {
            display: block;
        }

        .math-font {
            font-family: 'Orbitron', sans-serif;
        }

        /* Landscape Lock Overlay */
        #orientationOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #020617;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        @media (orientation: portrait) {
            #orientationOverlay {
                display: flex;
            }
        }

        #escButton {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            right: env(safe-area-inset-right, 20px);
            width: 54px;
            height: 54px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            color: white;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            z-index: 1000;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #escButton:active {
            background: var(--danger);
            transform: scale(0.9);
            border-color: transparent;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .mode-card.active {
            background: rgba(0, 242, 254, 0.2);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 5px var(--primary); }
            50% { box-shadow: 0 0 20px var(--primary); }
            100% { box-shadow: 0 0 5px var(--primary); }
        }

        .glow-effect {
            animation: pulse-glow 2s infinite;
        }

        .rotate-icon {
            animation: rotateDevice 2s ease-in-out infinite;
        }

        @keyframes rotateDevice {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-90deg); }
        }
    </style>
</head>
<body>

    <!-- บังคับแนวนอน -->
    <div id="orientationOverlay">
        <div class="rotate-icon mb-6">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
        </div>
        <h2 class="text-2xl font-bold mb-2">กรุณาหมุนโทรศัพท์แนวนอน</h2>
        <p class="text-slate-400">เพื่อประสบการณ์การท่องพหุจักรวาลที่ดีที่สุด</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- UI Overlay สำหรับ Tablet/Mobile -->
    <div id="escButton" onclick="handleEsc()">ESC</div>

    <div id="uiLayer" class="absolute inset-0 pointer-events-none flex items-center justify-center">
        
        <!-- Start Screen -->
        <div id="startScreen" class="pointer-events-auto glass-panel p-8 rounded-[2rem] text-center max-w-2xl border-t-2 border-cyan-400/50 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h1 class="math-font text-4xl md:text-5xl font-black mb-2 tracking-tighter bg-clip-text text-transparent bg-gradient-to-br from-cyan-400 to-purple-600">
                MATH MULTIVERSE
            </h1>
            <p class="text-slate-400 mb-6 font-light">เลือกโหมดการคำนวณแห่งมิติ</p>
            
            <!-- Mode Selection -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div onclick="selectMode('easy')" id="mode-easy" class="mode-card p-4 rounded-2xl border border-white/10 active">
                    <div class="text-cyan-400 font-bold mb-1">EASY</div>
                    <div class="text-[10px] text-slate-500 uppercase">บวก/ลบ พื้นฐาน</div>
                </div>
                <div onclick="selectMode('medium')" id="mode-medium" class="mode-card p-4 rounded-2xl border border-white/10">
                    <div class="text-purple-400 font-bold mb-1">NORMAL</div>
                    <div class="text-[10px] text-slate-500 uppercase">คูณพื้นฐาน</div>
                </div>
                <div onclick="selectMode('hard')" id="mode-hard" class="mode-card p-4 rounded-2xl border border-white/10">
                    <div class="text-red-400 font-bold mb-1">CHAOS</div>
                    <div class="text-[10px] text-slate-500 uppercase">โจทย์ผสมความไวสูง</div>
                </div>
            </div>

            <div class="space-y-4">
                <button onclick="requestStart()" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white py-4 rounded-2xl font-bold text-lg transition-all shadow-lg shadow-cyan-900/40">
                    เริ่มต้นการเดินทาง
                </button>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest">แตะหน้าจอเพื่อกระโดด • บังคับแนวนอนเท่านั้น</p>
            </div>
        </div>

        <!-- HUD -->
        <div id="hud" class="hidden absolute inset-0 pointer-events-none">
            <div class="absolute top-6 left-8 flex items-center gap-4">
                <div class="glass-panel px-5 py-2 rounded-2xl border-l-4 border-cyan-500">
                    <span class="text-[10px] text-slate-400 block uppercase font-bold">Score</span>
                    <span id="scoreVal" class="math-font text-2xl text-white">0</span>
                </div>
                <div class="glass-panel px-5 py-2 rounded-2xl border-l-4 border-purple-500">
                    <span class="text-[10px] text-slate-400 block uppercase font-bold">Level</span>
                    <span id="levelVal" class="math-font text-2xl text-white">1</span>
                </div>
            </div>

            <!-- Question Area -->
            <div class="absolute top-6 left-1/2 -translate-x-1/2">
                <div id="questionDisplay" class="glass-panel px-8 py-3 rounded-3xl border-b-4 border-white/10 text-center glow-effect min-w-[200px]">
                    <span id="modeLabel" class="text-[10px] text-cyan-400 block mb-1 uppercase tracking-widest font-bold italic">NORMAL MODE</span>
                    <div id="mathText" class="math-font text-3xl font-bold text-white">---</div>
                </div>
            </div>
        </div>

        <!-- Game Over -->
        <div id="gameOverScreen" class="hidden pointer-events-auto glass-panel p-10 rounded-[2rem] text-center border-t-2 border-red-500 shadow-2xl">
            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">โครงสร้างมิติพังทลาย!</h2>
            <p id="finalScoreDisplay" class="text-slate-400 mb-6 italic">คะแนนสุดท้าย: 0</p>
            
            <div class="flex flex-col gap-3">
                <button onclick="requestStart()" class="bg-white text-black py-4 px-10 rounded-2xl font-bold hover:bg-cyan-400 transition-colors">
                    เชื่อมต่อใหม่ (Retry)
                </button>
                <button onclick="showMenu()" class="text-slate-400 hover:text-white transition-colors py-2">
                    กลับหน้าหลัก
                </button>
            </div>
        </div>

    </div>

    <script>
        /**
         * MATH MULTIVERSE - ULTIMATE EDITION
         * บังคับแนวนอน, ระบบหลายโหมด, และรองรับ Fullscreen
         */

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const screens = {
            start: document.getElementById('startScreen'),
            hud: document.getElementById('hud'),
            over: document.getElementById('gameOverScreen')
        };
        const displays = {
            score: document.getElementById('scoreVal'),
            level: document.getElementById('levelVal'),
            math: document.getElementById('mathText'),
            finalScore: document.getElementById('finalScoreDisplay'),
            modeLabel: document.getElementById('modeLabel')
        };

        let state = {
            active: false,
            score: 0,
            level: 1,
            mode: 'easy',
            animationId: null,
            lastTime: 0
        };

        let player, portals, stars, currentTask;

        // ฟังก์ชันเลือกโหมด
        function selectMode(m) {
            state.mode = m;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`mode-${m}`).classList.add('active');
            
            const labels = { easy: 'EASY MODE', medium: 'NORMAL MODE', hard: 'CHAOS MODE' };
            displays.modeLabel.innerText = labels[m];
        }

        class Player {
            constructor() {
                this.width = 50;
                this.height = 30;
                this.reset();
            }

            reset() {
                this.x = 100;
                this.y = canvas.height / 2;
                this.dy = 0;
                this.gravity = 0.4;
                this.jumpStrength = -8;
                this.rotation = 0;
            }

            jump() {
                this.dy = this.jumpStrength;
            }

            update() {
                this.dy += this.gravity;
                this.y += this.dy;
                this.rotation = Math.atan2(this.dy, 12);

                if (this.y < 0) { this.y = 0; this.dy = 0; }
                if (this.y > canvas.height) endGame();
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                ctx.rotate(this.rotation);

                ctx.shadowBlur = 15;
                ctx.shadowColor = 'cyan';
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.moveTo(-this.width / 2, -this.height / 2);
                ctx.lineTo(this.width / 2, 0);
                ctx.lineTo(-this.width / 2, this.height / 2);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#0ea5e9';
                ctx.beginPath();
                ctx.arc(-2, 0, 6, 0, Math.PI * 2);
                ctx.fill();

                if (state.active) {
                    const engineSize = 8 + Math.random() * 8;
                    const grad = ctx.createLinearGradient(-this.width / 2 - engineSize, 0, -this.width / 2, 0);
                    grad.addColorStop(0, 'transparent');
                    grad.addColorStop(1, 'cyan');
                    ctx.fillStyle = grad;
                    ctx.fillRect(-this.width / 2 - engineSize, -4, engineSize, 8);
                }
                ctx.restore();
            }
        }

        class Portal {
            constructor(x, y, value, isCorrect, speed) {
                this.x = x;
                this.y = y;
                this.width = 80;
                this.height = 120;
                this.value = value;
                this.isCorrect = isCorrect;
                this.speed = speed;
                this.pulse = 0;
            }

            update() {
                this.x -= this.speed;
                this.pulse += 0.05;
            }

            draw() {
                const glowColor = this.isCorrect ? '#00f2fe' : '#ff0055';
                const pulseSize = Math.sin(this.pulse) * 4;

                ctx.save();
                ctx.shadowBlur = 15 + pulseSize;
                ctx.shadowColor = glowColor;
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 3;
                
                ctx.beginPath();
                ctx.roundRect(this.x, this.y, this.width, this.height, 15);
                ctx.stroke();

                ctx.shadowBlur = 0;
                ctx.fillStyle = 'white';
                ctx.font = 'bold 28px Orbitron';
                ctx.textAlign = 'center';
                ctx.fillText(this.value, this.x + this.width / 2, this.y + this.height / 2 + 10);
                ctx.restore();
            }
        }

        function createQuestion() {
            let a, b, result, op;
            const lv = state.level;

            if (state.mode === 'easy') {
                a = Math.floor(Math.random() * (10 + lv));
                b = Math.floor(Math.random() * (10 + lv));
                op = Math.random() > 0.3 ? '+' : '-';
                result = op === '+' ? a + b : a - b;
            } else if (state.mode === 'medium') {
                a = Math.floor(Math.random() * (5 + lv));
                b = Math.floor(Math.random() * (5 + lv));
                op = '×';
                result = a * b;
            } else { // Hard (Chaos)
                const type = Math.random();
                if (type < 0.4) {
                    a = Math.floor(Math.random() * (20 + lv * 2));
                    b = Math.floor(Math.random() * (20 + lv * 2));
                    op = Math.random() > 0.5 ? '+' : '-';
                    result = op === '+' ? a + b : a - b;
                } else {
                    a = Math.floor(Math.random() * (10 + lv));
                    b = Math.floor(Math.random() * (10 + lv));
                    op = '×';
                    result = a * b;
                }
            }
            
            displays.math.innerText = `${a} ${op} ${b}`;
            const wrongResult = result + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 5) + 1);
            
            const speed = (state.mode === 'hard' ? 7 : 5) + (lv * 0.4);
            const correctTop = Math.random() > 0.5;

            portals = [
                new Portal(canvas.width + 100, canvas.height/2 - 150, correctTop ? result : wrongResult, correctTop, speed),
                new Portal(canvas.width + 100, canvas.height/2 + 30, !correctTop ? result : wrongResult, !correctTop, speed)
            ];
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {});
            }
        }

        function requestStart() {
            toggleFullScreen();
            startGame();
        }

        function startGame() {
            if (state.animationId) cancelAnimationFrame(state.animationId);
            state.active = true;
            state.score = 0;
            state.level = 1;
            player = new Player();
            initStars();
            createQuestion();
            screens.start.classList.add('hidden');
            screens.over.classList.add('hidden');
            screens.hud.classList.remove('hidden');
            displays.score.innerText = '0';
            displays.level.innerText = '1';
            gameLoop();
        }

        function endGame() {
            state.active = false;
            cancelAnimationFrame(state.animationId);
            displays.finalScore.innerText = `คะแนนความเสถียร: ${state.score}`;
            screens.over.classList.remove('hidden');
            screens.hud.classList.add('hidden');
        }

        function showMenu() {
            state.active = false;
            cancelAnimationFrame(state.animationId);
            screens.start.classList.remove('hidden');
            screens.over.classList.add('hidden');
            screens.hud.classList.add('hidden');
        }

        function handleEsc() {
            if (state.active) endGame();
            showMenu();
        }

        function initStars() {
            stars = Array.from({ length: 100 }, () => ({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 1.5,
                speed: Math.random() * 1 + 0.2
            }));
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (player) player.reset();
            initStars();
        }

        function update() {
            if (!state.active) return;
            player.update();
            stars.forEach(s => {
                s.x -= s.speed;
                if (s.x < 0) s.x = canvas.width;
            });

            for (let i = portals.length - 1; i >= 0; i--) {
                const p = portals[i];
                p.update();

                if (player.x < p.x + p.width && player.x + player.width > p.x &&
                    player.y < p.y + p.height && player.y + player.height > p.y) {
                    if (p.isCorrect) {
                        state.score += (state.mode === 'hard' ? 20 : 10);
                        if (state.score % 100 === 0) state.level++;
                        displays.score.innerText = state.score;
                        displays.level.innerText = state.level;
                        createQuestion();
                        return;
                    } else endGame();
                }
                if (p.x + p.width < 0 && i === 0) { endGame(); return; }
            }
        }

        function draw() {
            ctx.fillStyle = '#020617';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            stars.forEach(s => {
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
            });
            portals.forEach(p => p.draw());
            player.draw();
        }

        function gameLoop() {
            if (!state.active) return;
            update();
            draw();
            state.animationId = requestAnimationFrame(gameLoop);
        }

        window.addEventListener('resize', resize);
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); player.jump(); }
            if (e.code === 'Escape') handleEsc();
        });
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (state.active) player.jump();
        }, { passive: false });

        resize();
    </script>
</body>
</html>
